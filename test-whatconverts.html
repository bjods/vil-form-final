<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WhatConverts Tracking Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .log-container {
            background: #f8f8f8;
            border: 1px solid #ddd;
            padding: 15px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
        }
        .log-entry {
            margin-bottom: 10px;
            padding: 8px;
            background: white;
            border-radius: 3px;
            border-left: 3px solid #007bff;
        }
        .log-entry.success {
            border-color: #28a745;
        }
        .log-entry.error {
            border-color: #dc3545;
        }
        .form-embed-container {
            min-height: 800px;
            margin: 20px 0;
        }
        h1, h2 {
            color: #333;
        }
        .test-button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
        }
        .test-button:hover {
            background: #0056b3;
        }
    </style>
</head>
<body>
    <h1>WhatConverts Tracking Test Page</h1>
    
    <div class="test-container">
        <h2>Form Embed Container</h2>
        <p>The form below will load and you can test the submission tracking:</p>
        
        <!-- Form embed container -->
        <div class="vl-form-embed" id="test-form-container"></div>
    </div>
    
    <div class="test-container">
        <h2>Event Tracking Log</h2>
        <p>All form-related events will be logged here:</p>
        <button class="test-button" onclick="clearLog()">Clear Log</button>
        <button class="test-button" onclick="simulateWhatConverts()">Simulate WhatConverts</button>
        <div id="event-log" class="log-container">
            <div class="log-entry">Waiting for events...</div>
        </div>
    </div>

    <script>
        // Event logging system
        const eventLog = [];
        const logContainer = document.getElementById('event-log');
        
        function addLogEntry(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const entry = {
                timestamp,
                message,
                type
            };
            eventLog.push(entry);
            
            const logElement = document.createElement('div');
            logElement.className = `log-entry ${type}`;
            logElement.innerHTML = `<strong>[${timestamp}]</strong> ${message}`;
            
            if (logContainer.children.length === 1 && logContainer.children[0].textContent === 'Waiting for events...') {
                logContainer.innerHTML = '';
            }
            
            logContainer.appendChild(logElement);
            logContainer.scrollTop = logContainer.scrollHeight;
        }
        
        function clearLog() {
            eventLog.length = 0;
            logContainer.innerHTML = '<div class="log-entry">Log cleared. Waiting for events...</div>';
        }
        
        // Listen for form load event
        window.addEventListener('vl-form-loaded', function(event) {
            addLogEntry(`Form loaded: ${JSON.stringify(event.detail)}`, 'success');
        });
        
        // Listen for form submission event
        window.addEventListener('vl-form-submitted', function(event) {
            addLogEntry(`Form submitted with data: ${JSON.stringify(event.detail, null, 2)}`, 'success');
            
            // Log individual fields for clarity
            const data = event.detail;
            addLogEntry(`Email: ${data.email || 'Not provided'}`);
            addLogEntry(`Phone: ${data.phone || 'Not provided'}`);
            addLogEntry(`Services: ${data.services || 'Not provided'}`);
        });
        
        // Listen for all form submit events (for hidden form tracking)
        document.addEventListener('submit', function(event) {
            if (event.target.id === 'vl-tracking-form') {
                addLogEntry('Hidden tracking form submit event triggered!', 'success');
                event.preventDefault(); // Prevent actual form submission
                
                // Log form data
                const formData = new FormData(event.target);
                const data = {};
                for (let [key, value] of formData.entries()) {
                    data[key] = value;
                }
                addLogEntry(`Tracking form data: ${JSON.stringify(data, null, 2)}`);
            }
        }, true);
        
        // Simulate WhatConverts tracking
        function simulateWhatConverts() {
            addLogEntry('Simulating WhatConverts tracking...', 'info');
            
            // Check if we can find form elements
            const forms = document.querySelectorAll('form');
            addLogEntry(`Found ${forms.length} form elements on page`);
            
            // Look for our tracking form
            const trackingForm = document.getElementById('vl-tracking-form');
            if (trackingForm) {
                addLogEntry('Found VL tracking form!', 'success');
                const inputs = trackingForm.querySelectorAll('input');
                addLogEntry(`Tracking form has ${inputs.length} input fields`);
                
                inputs.forEach(input => {
                    addLogEntry(`Field: ${input.name} = ${input.value}`);
                });
            } else {
                addLogEntry('VL tracking form not found (this is normal until form submission)', 'info');
            }
            
            // Check for data attributes
            const embedContainer = document.querySelector('.vl-form-embed');
            if (embedContainer) {
                const attributes = embedContainer.attributes;
                addLogEntry('Form container attributes:', 'info');
                for (let attr of attributes) {
                    if (attr.name.startsWith('data-')) {
                        addLogEntry(`${attr.name}: ${attr.value}`);
                    }
                }
            }
        }
        
        // Monitor DOM changes
        const observer = new MutationObserver(function(mutations) {
            mutations.forEach(function(mutation) {
                if (mutation.type === 'childList') {
                    mutation.addedNodes.forEach(function(node) {
                        if (node.nodeType === 1) { // Element node
                            if (node.tagName === 'FORM' && node.id === 'vl-tracking-form') {
                                addLogEntry('Hidden tracking form added to DOM', 'success');
                            }
                        }
                    });
                }
            });
        });
        
        observer.observe(document.body, {
            childList: true,
            subtree: true
        });
        
        // Log page load
        window.addEventListener('load', function() {
            addLogEntry('Test page loaded', 'info');
            addLogEntry(`Page URL: ${window.location.href}`);
            addLogEntry(`Referrer: ${document.referrer || 'None'}`);
        });
    </script>
    
    <!-- Load the embed script - using dev version for local testing -->
    <script src="public/embed-dev.js"></script>
    
    <!-- Alternative: For testing the production build locally -->
    <!-- First run: npm run preview -->
    <!-- Then uncomment this and comment out the embed-dev.js line above -->
    <!-- <script src="http://localhost:4173/embed.js"></script> -->
</body>
</html>